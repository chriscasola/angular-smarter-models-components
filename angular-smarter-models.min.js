var AngularSmarterModels;!function(t){t.smModule=angular.module("sm.models",[])}(AngularSmarterModels||(AngularSmarterModels={}));var AngularSmarterModels;!function(t){var e=function(){function t(t){this.config=t,angular.isObject(this.config.rawModel)||(this.config.rawModel={})}return Object.defineProperty(t.prototype,"props",{get:function(){return this.config.rawModel},enumerable:!0,configurable:!0}),t.prototype.serialize=function(){return JSON.stringify(this.config.rawModel)},t.prototype.merge=function(t){angular.extend(this.config.rawModel,t)},t.prototype.setModelPath=function(t){this.config.modelPath=t},t.prototype.getModelPath=function(){return this.config.modelPath},t.prototype.save=function(){return this.config.modelDataRetriever.save(this)},t.prototype["delete"]=function(){return this.config.modelDataRetriever["delete"](this.config.modelPath,this.config.listPath,this.config.idField)},t}();t.ModelInstance=e,t.smModule.value("SMModelInstance",e)}(AngularSmarterModels||(AngularSmarterModels={}));var AngularSmarterModels;!function(t){var e=function(){function t(t){this.config=t}return t.prototype.get=function(t){return this.config.modelDataRetriever.get(this.config.modelPath,this.config.listPath,t,this.config.ModelInstance,this.config.idField)},t.prototype.getAsync=function(t){return this.config.modelDataRetriever.getAsync(this.config.modelPath,this.config.listPath,t,this.config.ModelInstance,this.config.idField)},t.prototype.list=function(t){return this.config.modelDataRetriever.list(this.config.listPath,this.config.modelPath,t,this.config.idField)},t.prototype.listAsync=function(t){return this.config.modelDataRetriever.listAsync(this.config.listPath,this.config.modelPath,t,this.config.idField)},t.prototype.getMultipleAsync=function(t){var e=this.config.modelPath.split("/").slice(0,-1).join("/")+"/";return"/"===e.slice(-1)&&(e=e.slice(0,-1)),this.config.modelDataRetriever.getMultipleAsync(e,this.config.modelPath,t,this.config.ModelInstance,this.config.idField)},t.prototype.create=function(t,e){var i=this.config.modelPath.split("/").slice(0,-1).join("/")+"/";return this.config.modelDataRetriever.create(i,this.config.listPath,t,new this.config.ModelInstance({rawModel:e,modelDataRetriever:this.config.modelDataRetriever,modelPath:this.config.modelPath,idField:this.config.idField,listPath:this.config.listPath}))},t}();t.Model=e,t.smModule.value("SMModel",e)}(AngularSmarterModels||(AngularSmarterModels={}));var AngularSmarterModels;!function(t){var e=function(){function t(t){this._config=t}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config.config},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"props",{get:function(){return this._config.rawModel},enumerable:!0,configurable:!0}),t}();t.ModelListItemInstance=e,t.smModule.value("SMModelListItemInstance",e)}(AngularSmarterModels||(AngularSmarterModels={}));var AngularSmarterModels;!function(t){var e=function(){function t(t){this.config=t}return Object.defineProperty(t.prototype,"props",{get:function(){return void 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"error",{get:function(){return this.config.error},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"time",{get:function(){return this.config.time},enumerable:!0,configurable:!0}),t}();t.ModelError=e}(AngularSmarterModels||(AngularSmarterModels={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},AngularSmarterModels;!function(t){function e(t,e){return t.split("/").map(function(r){if(":"===r[0]){var n=e[r.slice(1)];if(null!==n&&void 0!==n)return n;throw new i('Missing required param "'+r.slice(1)+'" for path "'+t+'"!')}return r}).join("/")}var i=function(t){function e(e){t.call(this,e),this.message=e,this.name="ModelDataRetrieverError"}return __extends(e,t),e}(Error);t.ModelDataRetrieverError=i;var r=function(){function t(){this.cache={}}return t.prototype.has=function(t){return this.cache.hasOwnProperty(this.stripTrailingSlash(t))},t.prototype.get=function(t){return this.cache[this.stripTrailingSlash(t)]},t.prototype.set=function(t,e){this.cache[this.stripTrailingSlash(t)]=e},t.prototype.stripTrailingSlash=function(t){return"/"===t.slice(-1)?t.slice(0,-1):t},t}(),n=1e4,o=function(){function o(t,e){this.$q=t,this.$http=e,this.modelCache={},this.outstandingRequests={},this.listCache=new r}return o.prototype.cacheModel=function(t,e,i,r,n){var o=this,s=new i({rawModel:r,modelDataRetriever:o,modelPath:t,listPath:e,idField:n});return this.modelCache[t]=s,this.addModelToList(e,s,0),s},o.prototype.cacheError=function(e,i,r){var n=new t.ModelError({error:"An error occurred fetching the model!",time:Date.now()});return this.modelCache[e]=n,n},o.prototype.cacheList=function(t,e){return this.listCache.set(t,e),e},o.prototype.hasListCache=function(t){var e=this.listCache.get(t);return this.listCache.has(t)&&null!==e},o.prototype.shouldRetryFetch=function(t){return Date.now()-t.time>n},o.prototype.addModelToList=function(t,e,i){if(void 0===i&&(i=0),this.hasListCache(t)){for(var r=this.listCache.get(t),n=0;n<r.length;n++)if(r[n].props[e.config.idField]===e.props[e.config.idField])return void(r[n]=e);this.listCache.get(t).splice(i,0,e)}},o.prototype.removeModelFromList=function(t,e,i){for(var r=this.listCache.get(t),n=0;n<r.length;n++)if(r[n].props[i]===e){r.splice(n,1);break}},o.prototype.get=function(i,r,n,o,s){var a=e(i,n),l=this.modelCache[a],c=this.modelCache.hasOwnProperty(a);return(!c||l instanceof t.ModelError&&this.shouldRetryFetch(l))&&this.getAsync(i,r,n,o,s),c?l:void 0},o.prototype.getAsync=function(i,r,n,o,s){var a,l=this,c=e(i,n),h=this.modelCache[c];return!this.modelCache.hasOwnProperty(c)||h instanceof t.ModelError?this.outstandingRequests.hasOwnProperty(c)?a=this.outstandingRequests[c]:(a=this.$http.get(c).then(function(t){return l.cacheModel(c,r,o,t.data,s)})["catch"](function(t){return l.$q.reject(l.cacheError(c,r,s))})["finally"](function(){delete l.outstandingRequests[c]}),this.outstandingRequests[c]=a):a=this.$q.when(h),a},o.prototype.getMultipleAsync=function(t,e,i,r,n){return this.getMultipleHelper(t,e,i,r,n,!1)},o.prototype.list=function(t,i,r,n){var o=e(t,r);return this.hasListCache(o)?this.listCache.get(o):void(null!==this.listCache.get(o)&&this.listAsync(t,i,r,n))},o.prototype.listAsync=function(t,e,i,r){return this.getMultipleHelper(t,e,i,null,r,!0)},o.prototype.save=function(t){return this.$http.post(t.getModelPath(),t.serialize()).then(function(t){})},o.prototype.create=function(t,i,r,n){var o=this,s=e(t,r);return this.$http.put(s,n.serialize()).then(function(t){return n.merge(t.data),n.setModelPath(t.headers("Location")),o.modelCache[t.headers("Location")]=n,o.addModelToList(i,n),n})},o.prototype["delete"]=function(t,e,i){var r,n=this;return this.modelCache.hasOwnProperty(t)&&(r=this.modelCache[t].props[i]),delete this.modelCache[t],this.$http["delete"](t).then(function(t){null!=r&&n.removeModelFromList(e,r,i)})},o.prototype.getMultipleHelper=function(r,n,o,s,a,l){var c,h=this,u=e(r,o);return this.hasListCache(u)?c=this.$q.when(this.listCache.get(u)):this.outstandingRequests.hasOwnProperty(u)?c=this.outstandingRequests[u]:(c=this.$http.get(u).then(function(c){if(!angular.isArray(c.data))return h.$q.reject(new i('Expected array of models for list request for path "'+u+'"!'));var d=c.data.map(function(i){var c=(d={},d[a]=i[a],d);angular.extend(c,o);var u=e(n,c);return h.modelCache.hasOwnProperty(u)?h.modelCache[u]:l?new t.ModelListItemInstance({rawModel:i,config:{idField:a}}):h.cacheModel(u,r,s,i,a);var d});return h.cacheList(u,d)})["catch"](function(t){return h.listCache.set(u,null),h.$q.reject(t)})["finally"](function(){delete h.outstandingRequests[u]}),this.outstandingRequests[u]=c),c},o.$inject=["$q","$http"],o}();t.ModelDataRetriever=o;var s={setRetryInterval:function(t){n=t},$get:["$injector",function(t){return t.instantiate(o)}]};t.smModule.value("smModelDataRetrieverError",i).provider("smModelDataRetriever",s)}(AngularSmarterModels||(AngularSmarterModels={}));var AngularSmarterModels;!function(t){function e(t,e,r){var n=function(n,o){return new i(n,o,t,e,r,"id")};return n}var i=function(){function t(t,e,i,r,n,o){this.route=t,this._listPath=e,this.Model=i,this.ModelInstance=r,this._modelDataRetriever=n,this._idField=o}return t.prototype.model=function(t){return this.Model=t,this},t.prototype.modelInstance=function(t){return this.ModelInstance=t,this},t.prototype.modelDataRetriever=function(t){return this._modelDataRetriever=t,this},t.prototype.listPath=function(t){return this._listPath=t,this},t.prototype.idField=function(t){return this._idField=t,this},t.prototype.done=function(){return new this.Model({modelPath:this.route,ModelInstance:this.ModelInstance,modelDataRetriever:this._modelDataRetriever,listPath:this._listPath,idField:this._idField})},t}();t.ModelBuilder=i,e.$inject=["SMModel","SMModelInstance","smModelDataRetriever"],angular.module("sm.models").factory("smModelFactory",e)}(AngularSmarterModels||(AngularSmarterModels={}));
//# sourceMappingURL=angular-smarter-models.min.js.map